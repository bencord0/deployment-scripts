---
- name: "Formatting filesystem"
  filesystem:
    fstype: xfs
    dev: /dev/vdb

- name: "Mount build-artifacts"
  mount:
    name: /mnt/gentoo
    src: /dev/vdb
    fstype: xfs
    state: present

- name: "Ensure directories"
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /root
    - /usr/src
    - /usr/portage
    - /var/tmp/portage
    - /var/lib/portage/distfiles
    - /var/lib/portage/packages
    - /mnt/gentoo/root
    - /mnt/gentoo/src
    - /mnt/gentoo/portage
    - /mnt/gentoo/var-tmp-portage
    - /mnt/gentoo/distfiles
    - /mnt/gentoo/packages

- name: "Bind mount paths"
  mount:
    name: "{{ item.name }}"
    src: "{{ item.src }}"
    fstype: bind
    state: mounted
    opts: bind
  with_items:
    - { name: "/root", src: "/mnt/gentoo/root" }
    - { name: "/usr/src", src: "/mnt/gentoo/src" }
    - { name: "/usr/portage", src: "/mnt/gentoo/portage" }
    - { name: "/var/tmp/portage", src: "/mnt/gentoo/var-tmp-portage" }
    - { name: "/var/lib/portage/distfiles", src: "/mnt/gentoo/distfiles" }
    - { name: "/var/lib/portage/packages", src: "/mnt/gentoo/packages" }

- name: "Ensure /root/.ssh directory"
  file:
    path: "/root/.ssh"
    state: directory

- name: "Ensure ssh key in new root HOME"
  lineinfile:
    create: yes
    dest: /root/.ssh/authorized_keys
    line: "{{ bastion_ssh_key }}"
    state: present
